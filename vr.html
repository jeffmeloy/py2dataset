<!DOCTYPE html>
<html lang="en">
<head>
    <title>VR Cinema Player</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
        canvas { display: block; width: 100vw; height: 100vh; touch-action: none; }

        /* SETUP SCREEN */
        #setup { position: fixed; inset: 0; background: #121212; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .setup-box { width: 100%; max-width: 400px; background: #1e1e1e; padding: 25px; border-radius: 16px; border: 1px solid #333; text-align: center; }
        .file-btn { display: block; background: #252525; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; border: 2px dashed #444; transition: 0.2s; }
        .file-btn:hover { border-color: #007bff; background: #2a2a2a; }
        #fileInput { display: none; }
        #startBtn { width: 100%; padding: 16px; margin-top: 20px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        #startBtn.ready { opacity: 1; pointer-events: auto; }

        /* UNIFIED CONTROL BAR */
        #ui-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            z-index: 100; display: flex; align-items: center; gap: 8px; 
            background: rgba(20,20,20,0.9); padding: 8px 12px; border-radius: 30px; 
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            transition: opacity 0.3s; opacity: 0; pointer-events: none;
        }
        #ui-bar.visible { opacity: 1; pointer-events: auto; }
        
        .btn { background: #333; color: white; border: none; height: 40px; min-width: 40px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold; padding: 0 15px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn:hover { background: #555; }
        .btn.active { background: #007bff; }
        .btn-icon { padding: 0; width: 40px; border-radius: 50%; font-size: 18px; }
        
        /* VR Specific Button Style */
        #btnEnterVR { background: #007bff; }
        #btnEnterVR:hover { background: #0056b3; }

        .divider { width: 1px; height: 25px; background: #555; margin: 0 4px; }
        .label { font-size: 10px; color: #aaa; text-transform: uppercase; margin-right: 5px; margin-left: 5px; font-weight: bold; }
    </style>
    
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>

<div id="setup">
    <div class="setup-box">
        <h2>VR Cinema</h2>
        <label for="fileInput" class="file-btn" id="fileLabel">Select Video File</label>
        <input type="file" id="fileInput" accept="video/*">
        <button id="startBtn">LOAD PLAYER</button>
    </div>
</div>

<!-- MAIN UI -->
<div id="ui-bar">
    <button class="btn" id="btnEnterVR">ENTER VR</button>
    <div class="divider"></div>
    
    <span class="label">Mode</span>
    <button class="btn btn-icon active" id="btn2D" title="2D Mode">2D</button>
    <button class="btn btn-icon" id="btn3D" title="3D SBS Mode">3D</button>
    
    <div class="divider"></div>
    
    <span class="label">Size</span>
    <button class="btn btn-icon" id="btnZoomOut" title="Smaller / Further">-</button>
    <button class="btn btn-icon" id="btnZoomIn" title="Bigger / Closer">+</button>
    
    <div class="divider"></div>
    <button class="btn btn-icon" id="btnPlay" title="Play/Pause">⏯</button>
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { VRButton } from 'three/addons/webxr/VRButton.js';

    let scene, camera, renderer, controls;
    let video, screenGroup, mesh2D, meshLeft, meshRight;
    let currentDistance = 6.0; // Starting distance (meters)

    const els = {
        setup: document.getElementById('setup'),
        fileInput: document.getElementById('fileInput'),
        startBtn: document.getElementById('startBtn'),
        label: document.getElementById('fileLabel'),
        ui: document.getElementById('ui-bar'),
        btnEnterVR: document.getElementById('btnEnterVR'),
        btn2D: document.getElementById('btn2D'),
        btn3D: document.getElementById('btn3D'),
        btnZoomIn: document.getElementById('btnZoomIn'),
        btnZoomOut: document.getElementById('btnZoomOut'),
        btnPlay: document.getElementById('btnPlay')
    };

    // 1. INPUT HANDLING
    let videoSrc = null;
    els.fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        videoSrc = URL.createObjectURL(file);
        els.label.textContent = file.name;
        els.startBtn.classList.add('ready');
    });

    els.startBtn.addEventListener('click', () => {
        if (!videoSrc) return;
        els.setup.style.display = 'none';
        els.ui.classList.add('visible');
        init();
    });

    // 2. INIT ENGINE
    function init() {
        // Video
        video = document.createElement('video');
        video.src = videoSrc;
        video.crossOrigin = "anonymous";
        video.playsInline = true;
        video.loop = true;
        video.play();

        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.xr.setReferenceSpaceType('local');
        document.body.appendChild(renderer.domElement);

        // WebXR Button Logic (Hidden, triggered by our UI)
        const vrBtn = VRButton.createButton(renderer);
        vrBtn.style.display = 'none';
        document.body.appendChild(vrBtn);
        
        els.btnEnterVR.addEventListener('click', () => {
            vrBtn.click();
            // Optional: Update text based on state
            setTimeout(() => {
                if(renderer.xr.isPresenting) els.btnEnterVR.textContent = "EXIT VR";
                else els.btnEnterVR.textContent = "ENTER VR";
            }, 1000);
        });

        // Magic Window Controls (Mouse/Touch Drag)
        controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0, -currentDistance);
        controls.enableZoom = false; // Disable Orbit zoom, we use Physical zoom
        controls.enablePan = false;
        controls.rotateSpeed = -0.5;
        controls.update();

        // Create Screen
        createCinemaScreen();

        // Loop
        renderer.setAnimationLoop(() => {
            controls.update();
            renderer.render(scene, camera);
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        setupControls();
    }

    function createCinemaScreen() {
        const texture = new THREE.VideoTexture(video);
        texture.minFilter = THREE.LinearFilter;
        texture.magFilter = THREE.LinearFilter;
        texture.colorSpace = THREE.SRGBColorSpace;

        screenGroup = new THREE.Group();
        updateScreenDistance(); // Set initial Z
        scene.add(screenGroup);

        // Base Geometry (Standard 16:9, corrected by metadata later)
        const aspect = 16/9;
        const width = 8; 
        const height = width / aspect;
        const geo = new THREE.PlaneGeometry(width, height);

        // 2D Mesh (Layer 0 = Default/Desktop, Layer 1&2 = VR Left/Right for Mono viewing)
        mesh2D = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide }));
        mesh2D.layers.enable(1); mesh2D.layers.enable(2); // Visible in VR
        screenGroup.add(mesh2D);

        // 3D Left Mesh (Layer 1)
        const geoL = geo.clone();
        const uvL = geoL.attributes.uv;
        for(let i=0; i<uvL.count; i++) uvL.setX(i, uvL.getX(i) * 0.5);
        meshLeft = new THREE.Mesh(geoL, new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide }));
        meshLeft.layers.set(1); 
        meshLeft.visible = false;
        screenGroup.add(meshLeft);

        // 3D Right Mesh (Layer 2)
        const geoR = geo.clone();
        const uvR = geoR.attributes.uv;
        for(let i=0; i<uvR.count; i++) uvR.setX(i, (uvR.getX(i) * 0.5) + 0.5);
        meshRight = new THREE.Mesh(geoR, new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide }));
        meshRight.layers.set(2);
        meshRight.visible = false;
        screenGroup.add(meshRight);

        // Handle Aspect Ratio
        video.addEventListener('loadedmetadata', () => {
            if(!video.videoWidth) return;
            const vidAspect = video.videoWidth / video.videoHeight;
            // Scale Y instead of regenerating geometry
            const scaleY = (16/9) / vidAspect; 
            screenGroup.scale.set(1, scaleY, 1);
        });
    }

    function setupControls() {
        // Mode Switching
        els.btn2D.addEventListener('click', () => {
            els.btn2D.classList.add('active'); els.btn3D.classList.remove('active');
            mesh2D.visible = true; meshLeft.visible = false; meshRight.visible = false;
        });
        
        els.btn3D.addEventListener('click', () => {
            els.btn3D.classList.add('active'); els.btn2D.classList.remove('active');
            mesh2D.visible = false; meshLeft.visible = true; meshRight.visible = true;
            // Ensure Left eye is visible on Desktop (Layer 0) for preview
            meshLeft.layers.enable(0);
        });

        // Zoom (Distance)
        // Closer = Bigger (-Z decreases towards 0)
        // Further = Smaller (-Z increases)
        els.btnZoomIn.addEventListener('click', () => {
            currentDistance -= 1.0;
            if(currentDistance < 2.0) currentDistance = 2.0; // Max zoom in
            updateScreenDistance();
        });

        els.btnZoomOut.addEventListener('click', () => {
            currentDistance += 1.0;
            if(currentDistance > 15.0) currentDistance = 15.0; // Max zoom out
            updateScreenDistance();
        });

        // Playback
        els.btnPlay.addEventListener('click', () => {
            if(video.paused) { video.play(); els.btnPlay.textContent = '⏸'; }
            else { video.pause(); els.btnPlay.textContent = '▶'; }
        });
    }

    function updateScreenDistance() {
        // Move screen along negative Z axis
        if(screenGroup) screenGroup.position.set(0, 0, -currentDistance);
        
        // Update orbit controls target so rotation feels correct
        if(controls) {
            controls.target.set(0, 0, -currentDistance);
            controls.update();
        }
    }
</script>
</body>
</html>
